name: Sync songs.json from Google Sheet (manual, safest)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch JSON from Apps Script
        run: |
          curl -L "${{ secrets.SONGS_API_URL }}" -o /tmp/songs_api.json

      - name: Validate & Normalize (artists array schema)
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const raw = fs.readFileSync("/tmp/songs_api.json", "utf8").trim();

          // 防呆：抓到 HTML（登入頁/錯誤頁）就中止，避免覆蓋 songs.json
          if (raw.startsWith("<!DOCTYPE html") || raw.startsWith("<html")) {
            console.error("ERROR: Got HTML instead of JSON. Check Apps Script access/deploy.");
            process.exit(1);
          }

          let data;
          try { data = JSON.parse(raw); }
          catch (e) {
            console.error("ERROR: Invalid JSON:", e.message);
            process.exit(1);
          }

          if (!Array.isArray(data)) {
            console.error("ERROR: Expected array JSON from API.");
            process.exit(1);
          }

          // ✅ 完全對齊你的 songs.json schema：
          // { artists: [...], title: "...", page: "...", reel: "..." }
          const normalized = data.map((s) => {
            const title = (s.title ?? "").toString().trim();
            const page  = (s.page ?? "").toString().trim();
            const reel  = (s.reel ?? "").toString().trim();

            let artists = [];
            if (Array.isArray(s.artists)) {
              artists = s.artists.map(a => (a ?? "").toString().trim()).filter(Boolean);
            } else if (typeof s.artists === "string") {
              artists = s.artists.split(/,|，/g).map(x => x.trim()).filter(Boolean);
            } else if (typeof s.artist === "string") {
              artists = [s.artist.trim()].filter(Boolean);
            }

            return { artists, title, page, reel };
          }).filter(x => x.title || x.reel || x.artists.length);

          // 排序讓 diff 乾淨（可選）
          normalized.sort((a, b) => {
            const aa = (a.artists[0] || "").localeCompare(b.artists[0] || "");
            if (aa !== 0) return aa;
            return (a.title || "").localeCompare(b.title || "");
          });

          fs.writeFileSync("songs.json", JSON.stringify(normalized, null, 2) + "\n", "utf8");
          console.log("songs.json updated with", normalized.length, "items");
          NODE

      - name: Commit & push if changed
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add songs.json
          git commit -m "chore: sync songs.json from Google Sheet"
          git push
