name: Sync songs.json from Google Sheet (manual, safest)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch JSON from Apps Script
        run: |
          curl -L "${{ secrets.SONGS_API_URL }}" -o /tmp/songs_api.json

      - name: Validate & Normalize (date desc)
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const raw = fs.readFileSync("/tmp/songs_api.json", "utf8").trim();

          // 防呆：抓到 HTML（登入頁/錯誤頁）就中止，避免覆蓋 songs.json
          if (raw.startsWith("<!DOCTYPE html") || raw.startsWith("<html")) {
            console.error("ERROR: Got HTML instead of JSON. Check Apps Script access/deploy.");
            process.exit(1);
          }

          let data;
          try { data = JSON.parse(raw); }
          catch (e) {
            console.error("ERROR: Invalid JSON:", e.message);
            process.exit(1);
          }

          if (!Array.isArray(data)) {
            console.error("ERROR: Expected array JSON from API.");
            process.exit(1);
          }

          // 解析日期：只接受 YYYY-MM-DD；空值視為最舊
          function toTime(dateStr) {
            const s = (dateStr ?? "").toString().trim();
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!m) return 0;
            // 用 UTC 避免時區造成前一天/後一天
            const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
            return Date.UTC(y, mo, d);
          }

          const normalized = data.map((s) => {
            const title = (s.title ?? "").toString().trim();
            const page  = (s.page ?? "").toString().trim();
            const reel  = (s.reel ?? "").toString().trim();
            const date  = (s.date ?? "").toString().trim(); // ✅ 新增 date

            let artists = [];
            if (Array.isArray(s.artists)) {
              artists = s.artists.map(a => (a ?? "").toString().trim()).filter(Boolean);
            } else if (typeof s.artists === "string") {
              artists = s.artists.split(/,|，/g).map(x => x.trim()).filter(Boolean);
            } else if (typeof s.artist === "string") {
              artists = [s.artist.trim()].filter(Boolean);
            }

            return { artists, title, page, reel, date };
          }).filter(x => x.title || x.reel || x.artists.length);

          // ✅ 核心：依 date 新到舊排序；同日再用 title 排，讓順序穩定
          normalized.sort((a, b) => {
            const ta = toTime(a.date);
            const tb = toTime(b.date);
            if (tb !== ta) return tb - ta; // 新的在前
            return (a.title || "").localeCompare(b.title || "");
          });

          fs.writeFileSync("songs.json", JSON.stringify(normalized, null, 2) + "\n", "utf8");
          console.log("songs.json updated with", normalized.length, "items (sorted by date desc)");
          NODE

      - name: Commit & push if changed
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add songs.json
          git commit -m "chore: sync songs.json from Google Sheet" || echo "Nothing to commit"

          # ✅ 關鍵：先把遠端更新 rebase 進來，再 push（避免 fetch first）
          git pull --rebase origin main

          git push origin main
