name: Sync songs.json from Google Sheet (manual, safest)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ✅ 關鍵：不要 shallow clone，才拉得到遠端最新提交
          ref: main

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest from origin/main (rebase)
        run: |
          git pull --rebase origin main

      - name: Fetch JSON from Apps Script
        run: |
          curl -L "${{ secrets.SONGS_API_URL }}" -o /tmp/songs_api.json

      - name: Validate & Normalize (date desc)
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const raw = fs.readFileSync("/tmp/songs_api.json", "utf8").trim();

          if (raw.startsWith("<!DOCTYPE html") || raw.startsWith("<html")) {
            console.error("ERROR: Got HTML instead of JSON. Check Apps Script access/deploy.");
            process.exit(1);
          }

          let data;
          try { data = JSON.parse(raw); }
          catch (e) {
            console.error("ERROR: Invalid JSON:", e.message);
            process.exit(1);
          }

          if (!Array.isArray(data)) {
            console.error("ERROR: Expected array JSON from API.");
            process.exit(1);
          }

          function toTime(dateStr) {
            const s = (dateStr ?? "").toString().trim();
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (!m) return 0;
            return Date.UTC(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
          }

          const normalized = data.map((s) => {
            const title = (s.title ?? "").toString().trim();
            const page  = (s.page ?? "").toString().trim();
            const reel  = (s.reel ?? "").toString().trim();
            const date  = (s.date ?? "").toString().trim();

            let artists = [];
            if (Array.isArray(s.artists)) {
              artists = s.artists.map(a => (a ?? "").toString().trim()).filter(Boolean);
            } else if (typeof s.artists === "string") {
              artists = s.artists.split(/,|，/g).map(x => x.trim()).filter(Boolean);
            } else if (typeof s.artist === "string") {
              artists = [s.artist.trim()].filter(Boolean);
            }

            return { artists, title, page, reel, date };
          }).filter(x => x.title || x.reel || x.artists.length);

          normalized.sort((a, b) => {
            const ta = toTime(a.date);
            const tb = toTime(b.date);
            if (tb !== ta) return tb - ta; // ✅ 新到舊
            return (a.title || "").localeCompare(b.title || "");
          });

          fs.writeFileSync("songs.json", JSON.stringify(normalized, null, 2) + "\n", "utf8");
          console.log("songs.json updated with", normalized.length, "items");
          NODE

      - name: Commit & Push (with rebase retry)
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git add songs.json
          git commit -m "chore: sync songs.json from Google Sheet"

          # ✅ 再 rebase 一次 + push，避免你剛好在流程中有人又推了新 commit
          git pull --rebase origin main
          git push origin main
